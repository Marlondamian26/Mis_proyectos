CREATE USER phase_user WITH PASSWORD 'm';                       <---- crear usuario de la base de datos
CREATE DATABASE phase_platform OWNER phase_user;                <----- crear la base de datos

psql --version    <---- Verificar versión de Postgre
psql -U postgres  <---- entrar en postgre
postgres=# \q     <---- salir de postgre

psql -h localhost -U phase_user -p 5432 -d phase_platform       <---- acceder a la base de datos
\dt   o    \l                                                   <----- comprobar tablas en base de datos
\d+ nombre_tabla                                                <---- comprobar atributos de una tabla

psql -U phase_user -d phase_platform -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"   <----- borrar todas las tablas de la base de datos

psql -U phase_user -d phase_platform -c "
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO phase_user;
GRANT ALL ON SCHEMA public TO public;
COMMENT ON SCHEMA public IS 'standard public schema';"       <----- borrar toda la información de la base de datos


pg_dump -U phase_user -d phase_platform -Fc -f "phase_backup_$(Get-Date -Format 'yyyyMMdd').dump"     <----- hacer copia de seguridad de la base de datos

# Desde el terminal integrado de VSCode (Ctrl+`)
pg_dump -h localhost -U phase_user -d phase_platform -F c -b -v -f "backup_$(Get-Date -Format 'yyyy-MM-dd_HHmmss').dump"     <----- hacer copia de seguridad de la base de datos con fecha y hora

Get-ChildItem -Path . -Filter "phase_backup_*.dump" | Sort-Object LastWriteTime -Descending | Select-Object -First 1      <----- encontrar copia de seguridad de la base de datos








-- Eliminar tablas existentes (si es necesario)
DROP TABLE IF EXISTS tarjetas_rfid CASCADE;
DROP TABLE IF EXISTS facturas CASCADE;
DROP TABLE IF EXISTS pagos CASCADE;
DROP TABLE IF EXISTS tarifas CASCADE;
DROP TABLE IF EXISTS auditorias CASCADE;
DROP TABLE IF EXISTS conductores CASCADE;

-- Tabla conductores
CREATE TABLE conductores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre VARCHAR(100) NOT NULL,
    apellido VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    deleted_at TIMESTAMP
);

-- Tabla tarifas
CREATE TABLE tarifas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tipo_conector VARCHAR(50) NOT NULL,
    precio_kwh DECIMAL(4,2) NOT NULL CHECK (precio_kwh BETWEEN 0.1 AND 1.5),
    hora_inicio TIME NOT NULL,
    hora_fin TIME NOT NULL,
    moneda VARCHAR(3) NOT NULL CHECK (moneda IN ('CUP', 'USD')),
    deleted_at TIMESTAMP
);

-- Tabla pagos
CREATE TABLE pagos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    monto DECIMAL(10,2) NOT NULL,
    metodo_pago VARCHAR(20) NOT NULL CHECK (metodo_pago IN ('tarjeta', 'efectivo')),
    estado VARCHAR(20) NOT NULL CHECK (estado IN ('pendiente', 'confirmado', 'fallido')),
    fecha_hora TIMESTAMPTZ NOT NULL,
    banco VARCHAR(100),
    ultimos_digitos VARCHAR(4),
    conductor_id UUID REFERENCES conductores(id),
    tarifa_id UUID REFERENCES tarifas(id) NOT NULL,
    referencia_externa VARCHAR(255)
);

-- Tabla facturas
CREATE TABLE facturas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    monto DECIMAL(10,2) NOT NULL,
    moneda VARCHAR(3) NOT NULL CHECK (moneda IN ('CUP', 'USD')),
    consumo_kwh DECIMAL NOT NULL,
    iva DECIMAL NOT NULL,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'annulled')),
    audit_logs JSONB NOT NULL,
    fecha_emision TIMESTAMPTZ NOT NULL,
    notas TEXT,
    referencia_pago VARCHAR(255),
    pago_id UUID UNIQUE REFERENCES pagos(id) NOT NULL,
    conductor_id UUID REFERENCES conductores(id) NOT NULL,
    tarifa_id UUID REFERENCES tarifas(id) NOT NULL
);

-- Tabla tarjetas RFID
CREATE TABLE tarjetas_rfid (
    id VARCHAR(20) PRIMARY KEY CHECK (id LIKE 'TEMP-%' OR id LIKE 'PERM-%'),
    estado VARCHAR(20) NOT NULL CHECK (estado IN ('activa', 'inactiva', 'expirada')),
    fecha_emision DATE NOT NULL,
    fecha_expiracion DATE NOT NULL,
    es_temporal BOOLEAN DEFAULT false NOT NULL,
    deleted_at TIMESTAMP,
    motivo_inactivacion TEXT,
    conductor_id UUID REFERENCES conductores(id)
);

-- Tabla auditorias
CREATE TABLE auditorias (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tabla_afectada VARCHAR(100) NOT NULL,
    operacion VARCHAR(20) NOT NULL CHECK (operacion IN ('CREATE', 'UPDATE', 'DELETE')),
    datos_viejos JSONB,
    datos_nuevos JSONB,
    usuario VARCHAR(100) NOT NULL,
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    conductor_id UUID REFERENCES conductores(id)
);

-- Índices para optimización
CREATE INDEX idx_conductores_email ON conductores(email);
CREATE INDEX idx_pagos_fecha ON pagos(fecha_hora);
CREATE INDEX idx_facturas_conductor ON facturas(conductor_id);
CREATE INDEX idx_tarjetas_conductor ON tarjetas_rfid(conductor_id);




-- Permisos para el usuario de la aplicación:


--1. Conéctate como superusuario (postgres o un usuario con CREATEROLE)
psql -U postgres -d phase_platform


--2. Crea el rol admin_cpo con todos los privilegios
-- Crear el rol con privilegios completos
CREATE ROLE admin_cpo WITH LOGIN PASSWORD 'admin_cpo' SUPERUSER CREATEDB CREATEROLE;

-- Conceder todos los privilegios en la base de datos phase_platform
GRANT ALL PRIVILEGES ON DATABASE phase_platform TO admin_cpo;

-- Conceder todos los privilegios en el esquema public
GRANT ALL PRIVILEGES ON SCHEMA public TO admin_cpo;

-- Conceder todos los privilegios en todas las tablas
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO admin_cpo;

-- Conceder todos los privilegios en todas las secuencias
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO admin_cpo;

-- Conceder privilegios para objetos futuros
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO admin_cpo;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO admin_cpo;


--3. Verificar que phase_user conserva sus permisos
-- Verificar permisos de phase_user
\du phase_user

-- Si es necesario, restaurar permisos para phase_user
GRANT CONNECT ON DATABASE phase_platform TO phase_user;
GRANT USAGE ON SCHEMA public TO phase_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO phase_user;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO phase_user;


--4. Verificación final
-- Ver todos los roles
\du

-- Ver privilegios en la base de datos
\l phase_platform

-- Ver privilegios en tablas
\dp






//en el archivo app.module.ts
//en la configuración de TypeORM:
   synchronize: configService.get('NODE_ENV') !== 'production',     <-----para la sincronización de esquemas en modo producción con la base de datos
   synchronize: false,                                             <----para la no sincronización de esquemas


