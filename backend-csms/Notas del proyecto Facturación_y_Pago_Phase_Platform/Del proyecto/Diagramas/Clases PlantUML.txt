@startuml

' Estilos
skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 100

' Entidades principales
class Factura {
  +id: string
  +monto: number
  +moneda: 'CUP' | 'USD'
  +consumo_kwh: number
  +iva: number
  +status: 'active' | 'annulled'
  +auditLogs: AuditHistoryDto[]
  +fecha_emision: Date
  +notas?: string
  +referencia_pago?: string
}

class Pago {
  +id: string
  +monto: number
  +metodo_pago: 'tarjeta' | 'efectivo'
  +estado: 'pendiente' | 'confirmado' | 'fallido'
  +fecha_hora: Date
  +enlace_pago?: string
  +qr_data?: string
  +qr_expiracion?: Date
  +banco?: string
  +ultimos_digitos?: string
  +referencia_externa?: string
}

class Conductor {
  +id: string
  +nombre: string
  +apellido: string
  +email: string
  +password: string
  +deletedAt?: Date
}

class TarjetaRFID {
  +id: string
  +estado: string
  +fecha_emision: Date
  +fecha_expiracion: Date
  +es_temporal: boolean
  +deletedAt?: Date
  +motivo_inactivacion?: string
  +conductor_id?: string
}

class Tarifa {
  +id: string
  +tipo_conector: string
  +precio_kwh: number
  +hora_inicio: string
  +hora_fin: string
  +moneda: 'CUP' | 'USD'
  +deletedAt?: Date
  +precio_equivalente?: number
}

class AuditLog {
  +id: string
  +userId: string
  +action: string
  +entityName: string
  +entityId: string
  +oldData: any
  +newData: any
  +timestamp: Date
}

class Auditoria {
  +id: string
  +tablaAfectada: string
  +operacion: 'CREATE' | 'UPDATE' | 'DELETE'
  +datosViejos: any
  +datosNuevos: any
  +usuario: string
  +fecha: Date
}

' DTOs
class CreateFacturaDto {
  +amount: number
  +currency: string
  +driverId: string
  +paymentMethod: string
  +kWh: number
  +tariff: number
  +iva: number
}

class CreateConductorDto {
  +nombre: string
  +apellido: string
  +email: string
  +password: string
}

class CreateTarjetaDto {
  +id: string
  +fecha_expiracion: Date
  +es_temporal?: boolean
  +conductor_id?: string
}

class AuditHistoryDto {
  +action: string
  +timestamp: Date
  +userId: string
  +changedFields: Record<string, any>
}

' Relaciones
Factura "1" -- "1" Pago : tiene >
Factura "1" -- "1" Conductor : pertenece a >
Factura "1" -- "1" Tarifa : usa >
TarjetaRFID "1" -- "0..1" Conductor : asignada a >
Pago "1" -- "1" Conductor : realizado por >
Pago "1" -- "1" Tarifa : aplica >
AuditLog "1" -- "*" Factura : registra >
Auditoria "1" -- "*" TarjetaRFID : registra >
Auditoria "1" -- "*" Tarifa : registra >

' Enumeraciones
enum AuditAction {
  CREATE
  UPDATE
  DELETE
  ANNULLED
  SOFT_DELETE
}

@enduml